#######################################################################
#
#   Copyright (c) 2016 Orange
#   valentin.boucher@orange.com
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
########################################################################

########################################################################
# This Blueprint deploy the clearwater IMS on an openstack environment
########################################################################

tosca_definitions_version: cloudify_dsl_1_3

imports:
  - http://www.getcloudify.org/spec/cloudify/4.0.1/types.yaml
  - https://github.com/boucherv-orange/cloudify-openstack-plugin/raw/2.0-devel/plugin.yaml
  - https://raw.githubusercontent.com/boucherv-orange/cloudify-openstack-adds-plugin/master/plugin.yaml
  - http://www.getcloudify.org/spec/diamond-plugin/1.3/plugin.yaml
  - types/monitoring.yaml
  - types/clearwater.yaml

inputs:

  image_id:
    type: string
    description: Image ID of the agent VM's (Ubuntu 14.04 for clearwater)

  flavor_id:
    type: string
    description: Flavor ID of the agent VM's (RAM >= 2 GB)

  agent_user:
    type: string
    default: ubuntu
    description: User for connecting to agent VM's

  key_pair_name:
    default: clearwater-key
    description: Openstack key pair name of the key to associate with the new server

  private_key_path:
    description: |
      Path to the private key which will be used for connecting to the server
      on the manager or machine running CLI if running in local mode.

  network_name:
    description: Openstack network name the new server will be connected to
    default: IMS-net2

  external_network_name:
    type: string
    description: Network that will be the floating IP

  ellis_network_name:
    description: Openstack network name the new server will be connected to
    default: IMS-net1

  ellis_external_network_name:
    type: string
    description: Network that will be the floating IP
    default: ext-net1

  local_private_domain:
    type: string
    default: site1.clearwater.local
    description: Sip domain for Internal communication

  remote_private_domain:
    type: string
    default: site2.clearwater.local
    description: Sip domain for Internal communication

  public_domain:
    type: string
    description: Sip domain for sip users and bono load-balancing

  ha_region:
    default: ''
    type: string

  noha_region:
    default: ''
    type: string

  central_region:
    default: ''
    type: string

  dns_ips:
    default: []
    description: ips of desginate api and dns server

  etcd_ip:
    type: string
    description: ip of etcd cluster

  with_ellis:
    type: integer
    description: 1 for true 0 for false
    default: 1

dsl_definitions:

  noha_openstack_config: &noha_openstack_config
    username: { get_secret: keystone_username }
    password: { get_secret: keystone_password }
    tenant_name: { get_secret: keystone_tenant_name }
    auth_url: { get_secret: keystone_url }
    region: { get_input: noha_region }

  ha_openstack_config: &ha_openstack_config
    username: { get_secret: keystone_username }
    password: { get_secret: keystone_password }
    tenant_name: { get_secret: keystone_tenant_name }
    auth_url: { get_secret: keystone_url }
    region: { get_input: ha_region }

  central_openstack_config: &central_openstack_config
    username: { get_secret: keystone_username }
    password: { get_secret: keystone_password }
    tenant_name: { get_secret: keystone_tenant_name }
    auth_url: { get_secret: keystone_url }
    region: { get_input: central_region }

node_types:

  # Global types for VMs
  #   - specifies defaults flavor, image and user agent to use for VMs
  #   - install monitoring agent on VMs
  #   - adding some monitoring collectors (CPU, RAM, DISK and Network)

  clearwater.nodes.MonitoredServer:
    derived_from: cloudify.openstack.nodes.Server
    properties:
      openstack_config:
        default: *ha_openstack_config
      cloudify_agent:
        default:
          user: { get_input: agent_user }
          key: { get_property: [ keypair, private_key_path ] }
      image:
        default: { get_input: image_id }
      flavor:
        default: { get_input: flavor_id }
      management_network_name:
        default: { get_input: network_name }
    interfaces:
      cloudify.interfaces.monitoring_agent:
        install:
          implementation: diamond.diamond_agent.tasks.install
          inputs:
            diamond_config:
              default:
                interval: 5
        start: diamond.diamond_agent.tasks.start
        stop: diamond.diamond_agent.tasks.stop
        uninstall: diamond.diamond_agent.tasks.uninstall

      cloudify.interfaces.monitoring:
          start:
            implementation: diamond.diamond_agent.tasks.add_collectors
            inputs:
              collectors_config:
                default:
                  CPUCollector: {}
                  MemoryCollector: {}
                  LoadAverageCollector: {}
                  DiskUsageCollector:
                    config:
                      devices: x?vd[a-z]+[0-9]*$
                  NetworkCollector: {}

  clearwater.nodes.config:
    derived_from: clearwater.nodes.base.config
    properties:
      private_domain:
        type: string
        default: { get_input: local_private_domain }
      remote_private_domain:
        type: string
        default: { get_input: remote_private_domain }
      public_domain:
        type: string
        default: { get_input: public_domain }
      dns_ips:
        default: { get_input: dns_ips }
      remote_etcd_ip:
        default: { get_input: etcd_ip }

relationships:
  cw_base_connected_to_DNS:
    derived_from: cloudify.openstack_adds.node_connected_to_DNS
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        establish:
          implementation: openstack_adds.designate_plugin.recordsets.add_node
          executor: central_deployment_agent
          inputs:
            domain:
              default: { get_input: local_private_domain }
            record_ip:
              default: ""
            other_roles:
              default: []
            other_records:
              default: []
        unlink:
          implementation: openstack_adds.designate_plugin.recordsets.del_node
          executor: central_deployment_agent
          inputs:
            domain:
              default: { get_input: local_private_domain }
            record_ip:
              default: ""
            other_roles:
              default: []
            other_records:
              default: []

node_templates:


  keypair:
    type: cloudify.openstack.nodes.KeyPair
    properties:
      openstack_config: *ha_openstack_config
      resource_id: { get_input: key_pair_name }
      use_external_resource: true
      private_key_path: { get_input: private_key_path }

  # Declare host VMs and attach them at floating ip or security group
  sprout_host:
    type: clearwater.nodes.MonitoredServer
    capabilities:
      scalable:
        properties:
          default_instances: 1
          min_instances: 1
    relationships:
      - type: cloudify.openstack.server_connected_to_keypair
        target: keypair

      - target: base_security_group
        type: cloudify.openstack.server_connected_to_security_group

      - target: internal_sip_security_group
        type: cloudify.openstack.server_connected_to_security_group

      - target: sprout_security_group
        type: cloudify.openstack.server_connected_to_security_group

  bono_port:
    type: cloudify.openstack.nodes.Port
    properties:
      use_external_resource: true
      openstack_config: *central_openstack_config
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            args:
              port_ip: { get_attribute: [ bono_host, ip ] }
    relationships:
      - type: cloudify.relationships.connected_to
        target: bono_host
      - type: cloudify.openstack.port_connected_to_floating_ip
        target: bono_floatingip

  bono_host:
    type: clearwater.nodes.MonitoredServer
    capabilities:
      scalable:
        properties:
          min_instances: 1
    relationships:
      - type: cloudify.openstack.server_connected_to_keypair
        target: keypair

      - target: base_security_group
        type: cloudify.openstack.server_connected_to_security_group

      - target: bono_security_group
        type: cloudify.openstack.server_connected_to_security_group

      - target: internal_sip_security_group
        type: cloudify.openstack.server_connected_to_security_group

  ellis_port:
    type: cloudify.openstack.nodes.Port
    capabilities:
      scalable:
        properties:
          min_instances: { get_input: with_ellis }
          max_instances: { get_input: with_ellis }
    properties:
      use_external_resource: true
      openstack_config: *central_openstack_config
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            args:
              port_ip: { get_attribute: [ ellis_host, ip ] }
    relationships:
      - type: cloudify.relationships.connected_to
        target: ellis_host
      - type: cloudify.openstack.port_connected_to_floating_ip
        target: ellis_floatingip

  ellis_host:
    type: clearwater.nodes.MonitoredServer
    capabilities:
      scalable:
        properties:
          min_instances: { get_input: with_ellis }
          max_instances: { get_input: with_ellis }
    properties:
      openstack_config: *noha_openstack_config
      management_network_name: { get_input: ellis_network_name }
    relationships:
      - type: cloudify.openstack.server_connected_to_keypair
        target: keypair

      - target: ellis_security_group
        type: cloudify.openstack.server_connected_to_security_group

  vellum_host:
    type: clearwater.nodes.MonitoredServer
    capabilities:
      scalable:
        properties:
          min_instances: 1
    relationships:
      - type: cloudify.openstack.server_connected_to_keypair
        target: keypair

      - target: base_security_group
        type: cloudify.openstack.server_connected_to_security_group

      - target: vellum_security_group
        type: cloudify.openstack.server_connected_to_security_group

  dime_host:
    type: clearwater.nodes.MonitoredServer
    capabilities:
      scalable:
        properties:
          min_instances: 1
    relationships:
      - type: cloudify.openstack.server_connected_to_keypair
        target: keypair

      - target: base_security_group
        type: cloudify.openstack.server_connected_to_security_group

      - target: dime_security_group
        type: cloudify.openstack.server_connected_to_security_group

  homer_host:
    type: clearwater.nodes.MonitoredServer
    capabilities:
      scalable:
        properties:
          min_instances: 1
    relationships:
      - type: cloudify.openstack.server_connected_to_keypair
        target: keypair

      - target: base_security_group
        type: cloudify.openstack.server_connected_to_security_group

      - target: homer_security_group
        type: cloudify.openstack.server_connected_to_security_group


  site_management_host:
    type: cloudify.openstack.nodes.Server
    capabilities:
      scalable:
        properties:
          min_instances: 1
          max_instances: 1
    properties:
      cloudify_agent:
          user: { get_input: agent_user }
          key: { get_property: [ keypair, private_key_path ] }
      image: { get_input: image_id }
      flavor: { get_input: flavor_id }
      management_network_name: { get_input: network_name }
      openstack_config: *ha_openstack_config
    interfaces:
      cloudify.interfaces.monitoring_agent:
        install:
          implementation: diamond.diamond_agent.tasks.install
          inputs:
            diamond_config:
              interval: 10
        start: diamond.diamond_agent.tasks.start
        stop: diamond.diamond_agent.tasks.stop
        uninstall: diamond.diamond_agent.tasks.uninstall
    relationships:
      - type: cloudify.openstack.server_connected_to_keypair
        target: keypair

  # Declare clearwater and other software
  sprout:
    type: clearwater.nodes.sprout
    properties:
      private_domain: { get_input: local_private_domain }
      etcd_ip: { get_attribute: [ site_management_host, ip ] }
    relationships:
      - type: cloudify.relationships.contained_in
        target: sprout_host
      - type: cw_base_connected_to_DNS
        target: dns
        source_interfaces:
          cloudify.interfaces.relationship_lifecycle:
            establish:
              inputs:
                other_roles:
                  - icscf
                  - scscf
                other_records:
                  SRV:
                    _sip._tcp.sprout: "0 0 5054"
                    _sip._tcp.scscf.sprout: "0 0 5054"
                    _sip._tcp.icscf.sprout: "0 0 5052"
            unlink:
              inputs:
                other_roles:
                  - icscf
                  - scscf
                other_records:
                  SRV:
                    _sip._tcp.sprout: "0 0 5054"
                    _sip._tcp.scscf.sprout: "0 0 5054"
                    _sip._tcp.icscf.sprout: "0 0 5052"
      - type: monitors_sprout_nodes
        target: snmp_poller

  bono:
    type: clearwater.nodes.bono
    properties:
      private_domain: { get_input: local_private_domain }
      etcd_ip: { get_attribute: [ site_management_host, ip ] }
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            public_ip: { get_attribute: [ bono_floatingip, floating_ip_address ] }
    relationships:
      - type: cloudify.relationships.contained_in
        target: bono_host
      - type: cloudify.openstack_adds.node_connected_to_DNS
        target: dns
        source_interfaces:
          cloudify.interfaces.relationship_lifecycle:
            establish:
              inputs:
                domain: { get_input: public_domain }
                record_ip: { get_attribute: [ bono_floatingip, floating_ip_address ]}
                other_records:
                  SRV:
                    _sip._tcp: "0 0 5060"
                    _sip._udp: "0 0 5060"
            unlink:
              inputs:
                domain: { get_input: public_domain }
                record_ip: { get_attribute: [ bono_floatingip, floating_ip_address ]}
                other_records:
                  SRV:
                    _sip._tcp: "0 0 5060"
                    _sip._udp: "0 0 5060"
      - type: monitors_bono_nodes
        target: snmp_poller

  ellis:
    type: clearwater.nodes.ellis
    properties:
      private_domain: { get_input: local_private_domain }
      etcd_ip: { get_attribute: [ site_management_host, ip ] }
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            public_ip: { get_attribute: [ ellis_floatingip, floating_ip_address ] }
    relationships:
      - type: cloudify.relationships.contained_in
        target: ellis_host
      - type: cloudify.openstack_adds.node_connected_to_DNS
        target: dns
        source_interfaces:
          cloudify.interfaces.relationship_lifecycle:
            establish:
              inputs:
                domain: { get_input: public_domain }
                record_ip: { get_attribute: [ ellis_floatingip, floating_ip_address ]}
            unlink:
              inputs:
                domain: { get_input: public_domain }
                record_ip: { get_attribute: [ ellis_floatingip, floating_ip_address ]}

  dime:
    type: clearwater.nodes.dime
    properties:
      private_domain: { get_input: local_private_domain }
      etcd_ip: { get_attribute: [ site_management_host, ip ] }
    relationships:
      - type: cloudify.relationships.contained_in
        target: dime_host
      - type: cw_base_connected_to_DNS
        target: dns

  vellum:
    type: clearwater.nodes.vellum
    properties:
      private_domain: { get_input: local_private_domain }
      etcd_ip: { get_attribute: [ site_management_host, ip ] }
    relationships:
      - type: cloudify.relationships.contained_in
        target: vellum_host
      - type: cw_base_connected_to_DNS
        target: dns

  homer:
    type: clearwater.nodes.homer
    properties:
      private_domain: { get_input: local_private_domain }
      etcd_ip: { get_attribute: [ site_management_host, ip ] }
    relationships:
      - type: cloudify.relationships.contained_in
        target: homer_host
      - type: cw_base_connected_to_DNS
        target: dns

  snmp_poller:
    type: SNMPProxy
    relationships:
      - type: cloudify.relationships.contained_in
        target: site_management_host

  dns:
    type: cloudify.openstack_adds.nodes.DNS_client
    properties:
      dns_ips: { get_input: dns_ips }
      domains:
        - { get_input: local_private_domain }
        - { get_input: public_domain }
      install_agent: false

  config:
    type: clearwater.nodes.config
    properties:
      etcd_ip: { get_attribute: [ site_management_host, ip ] }
    interfaces:
      cloudify.interfaces.lifecycle:
        configure: scripts/clearwater/other/install-etcd.sh
    relationships:
      - type: cloudify.relationships.contained_in
        target: site_management_host

  # Declare all security groups for clearwater and other nodes
  base_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      openstack_config: *ha_openstack_config
      security_group:
        name: clearwater-sg_base
        description: SSH
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 22
        - remote_ip_prefix: 0.0.0.0/0
          port: 4000
        - remote_ip_prefix: 0.0.0.0/0
          port: 2380
        - remote_ip_prefix: 0.0.0.0/0
          port: 161
          protocol: udp
        - remote_ip_prefix: 0.0.0.0/0
          port_range_min: 0
          port_range_max: 0
          protocol: icmp

  bono_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      openstack_config: *ha_openstack_config
      security_group:
        name: clearwater-sg_bono
        description: STUN SIP RTP 0MQ
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 3478
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 3478
          protocol: udp
        - remote_ip_prefix: 0.0.0.0/0
          port: 5060
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 5060
          protocol: udp
        - remote_ip_prefix: 0.0.0.0/0
          port: 5062
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port_range_min: 32768
          port_range_max: 65535
          protocol: udp
        - remote_ip_prefix: 0.0.0.0/0
          port: 6669
        - remote_ip_prefix: 0.0.0.0/0
          port: 5058
          protocol: tcp

  internal_sip_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      openstack_config: *ha_openstack_config
      security_group:
        name: clearwater-sg_internal_sip
        description: Internal SIP signalling
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 5058
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 5054
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 5052
          protocol: tcp

  sprout_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      openstack_config: *ha_openstack_config
      security_group:
        name: clearwater-sg_sprout
        description: memcached Chronos 0MQ
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 9888
          protocol: tcp

  dime_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      openstack_config: *ha_openstack_config
      security_group:
        name: clearwater-sg_dime
        description: memcached Chronos REST
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 8888
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 8889
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 10888
          protocol: tcp

  vellum_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      openstack_config: *ha_openstack_config
      security_group:
        name: clearwater-sg_vellum
        description: REST Cassandra 0MQ
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 11211
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 11311
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 7253
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 7000
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 9160
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port_range_min: 6667
          port_range_max: 6668

  homer_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      openstack_config: *ha_openstack_config
      security_group:
        name: clearwater-sg_homer
        description: REST Cassandra 0MQ
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 7888
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 9160
          protocol: tcp

  ellis_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    capabilities:
      scalable:
        properties:
          min_instances: { get_input: with_ellis }
          max_instances: { get_input: with_ellis }
    properties:
      openstack_config: *noha_openstack_config
      security_group:
        name: clearwater-sg_ellis
        description: Web UI
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 22
        - remote_ip_prefix: 0.0.0.0/0
          port: 4000
        - remote_ip_prefix: 0.0.0.0/0
          port: 2380
        - remote_ip_prefix: 0.0.0.0/0
          port: 80
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port: 443
          protocol: tcp
        - remote_ip_prefix: 0.0.0.0/0
          port_range_min: 0
          port_range_max: 0
          protocol: icmp

  # Declare floating IP for bono and ellis nodes
  bono_floatingip:
    type: cloudify.openstack.nodes.FloatingIP
    properties:
      openstack_config: *central_openstack_config
      floatingip:
        floating_network_name: { get_input: external_network_name }

  ellis_floatingip:
    type: cloudify.openstack.nodes.FloatingIP
    capabilities:
      scalable:
        properties:
          min_instances: { get_input: with_ellis }
          max_instances: { get_input: with_ellis }
    properties:
      openstack_config: *central_openstack_config
      floatingip:
        floating_network_name: { get_input: ellis_external_network_name }


groups:
  bono_group:
    members: [bono_host, bono_floatingip]

policies:
  scale_bono:
    type: cloudify.policies.scaling
    properties:
      default_instances: 1
    targets: [bono_group]
